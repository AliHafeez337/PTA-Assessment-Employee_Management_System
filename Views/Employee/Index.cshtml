@model List<EmployeeManagementSystem.Models.Employee>

@{
    ViewData["Title"] = "Employees";
}

@Html.AntiForgeryToken()

<!-- Success/Error Alert -->
<div id="alertBox" class="alert d-none" role="alert"></div>

<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Employee Management</h2>
    <button type="button" class="btn btn-primary" onclick="openCreateModal()">
        + Add Employee
    </button>
</div>

<!-- ─── SEARCH & FILTER BAR ─────────────────────────────────── -->
<form method="get" asp-action="Index" class="card shadow-sm mb-3">
    <div class="card-body">
        <div class="row g-2 align-items-end">

            <!-- Search by name -->
            <div class="col-md-5">
                <label class="form-label fw-semibold">Search by Name</label>
                <input type="text"
                       name="searchName"
                       value="@ViewBag.SearchName"
                       class="form-control"
                       placeholder="Type employee name..." />
            </div>

            <!-- Filter by department -->
            <div class="col-md-4">
                <label class="form-label fw-semibold">Filter by Department</label>
                <select name="departmentId" class="form-select">
                    <option value="0">-- All Departments --</option>
                    @foreach (var dept in ViewBag.Departments as List<EmployeeManagementSystem.Models.Department>)
                    {
                        <option value="@dept.DepartmentId"
                                selected="@(dept.DepartmentId == (int?)ViewBag.SelectedDepartmentId ? "selected" : null)">
                            @dept.DepartmentName
                        </option>
                    }
                </select>
            </div>

            <!-- Buttons -->
            <div class="col-md-3 d-flex gap-2">
                <button type="submit" class="btn btn-primary w-100">Search</button>
                <a asp-action="Index" class="btn btn-outline-secondary w-100">Clear</a>
            </div>

        </div>
    </div>
</form>

<!-- ─── RESULTS COUNT ─────────────────────────────────────────── -->
<p class="text-muted mb-2">
    @if (!string.IsNullOrWhiteSpace(ViewBag.SearchName as string) || (ViewBag.SelectedDepartmentId != null && (int?)ViewBag.SelectedDepartmentId > 0))
    {
        <span>Showing <strong>@Model.Count</strong> result(s) for applied filters.</span>
    }
    else
    {
        <span>Total: <strong>@Model.Count</strong> employee(s)</span>
    }
</p>

<!-- ─── EMPLOYEE TABLE ────────────────────────────────────────── -->
<div class="card shadow-sm">
    <div class="card-body p-0">
        <table class="table table-striped table-hover mb-0">
            <thead class="table-dark">
                <tr>
                    <th>#</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Salary</th>
                    <th>Department</th>
                    <th>Joining Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (!Model.Any())
                {
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            No employees found.
                            @if (!string.IsNullOrWhiteSpace(ViewBag.SearchName as string) || (ViewBag.SelectedDepartmentId != null && (int?)ViewBag.SelectedDepartmentId > 0))
                            {
                                <span>Try adjusting your filters or <a asp-action="Index">clear them</a>.</span>
                            }
                        </td>
                    </tr>
                }
                else
                {
                    int i = 1;
                    foreach (var emp in Model)
                    {
                        <tr id="row-@emp.EmployeeId">
                            <td>@(i++)</td>
                            <td>@emp.Name</td>
                            <td>@emp.Email</td>
                            <td>@emp.Salary.ToString("C")</td>
                            <td>@(emp.Department?.DepartmentName ?? "N/A")</td>
                            <td>@emp.JoiningDate?.ToString("MMM dd, yyyy")</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1"
                                        onclick="openEditModal(@emp.EmployeeId)">
                                    Edit
                                </button>
                                <button class="btn btn-sm btn-outline-danger"
                                        onclick="deleteEmployee(@emp.EmployeeId, '@emp.Name')">
                                    Delete
                                </button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<!-- ─── MODAL ─────────────────────────────────────────────────── -->
<div class="modal fade" id="employeeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" id="modalContent">
        </div>
    </div>
</div>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")

    <script>
        // ─── CREATE ───────────────────────────────────────────────
        function openCreateModal() {
            $.get('/Employee/Create', function (html) {
                $('#modalContent').html(html);
                bindFormSubmit('createForm', '/Employee/Create');
                $('#employeeModal').modal('show');
            }).fail(function (xhr) {
                showAlert('danger', 'Failed to load form: ' + xhr.status);
            });
        }

        // ─── EDIT ─────────────────────────────────────────────────
        function openEditModal(id) {
            $.get('/Employee/Edit/' + id, function (html) {
                $('#modalContent').html(html);
                bindFormSubmit('editForm', '/Employee/Edit');
                $('#employeeModal').modal('show');
            }).fail(function (xhr) {
                showAlert('danger', 'Failed to load form: ' + xhr.status);
            });
        }

        // ─── BIND SUBMIT ──────────────────────────────────────────
        function bindFormSubmit(formId, url) {
            $.validator.unobtrusive.parse('#' + formId);

            $('#' + formId).on('submit', function (e) {
                e.preventDefault();

                var form = $(this);
                if (!form.valid()) return;

                $.ajax({
                    url: url,
                    type: 'POST',
                    data: form.serialize(),
                    success: function (res) {
                        if (res && res.success === true) {
                            $('#employeeModal').modal('hide');
                            showAlert('success', res.message);
                            setTimeout(function () { location.reload(); }, 800);
                        } else if (res && res.success === false) {
                            showAlert('danger', res.message);
                        } else {
                            $('#modalContent').html(res);
                            bindFormSubmit(formId, url);
                        }
                    },
                    error: function (xhr) {
                        showAlert('danger', 'Server error ' + xhr.status + ': ' + xhr.responseText.substring(0, 200));
                    }
                });
            });
        }

        // ─── DELETE ───────────────────────────────────────────────
        function deleteEmployee(id, name) {
            if (!confirm('Are you sure you want to delete "' + name + '"?')) return;

            $.post('/Employee/Delete/' + id,
                { __RequestVerificationToken: getToken() },
                function (res) {
                    if (res.success) {
                        $('#row-' + id).fadeOut(300, function () { $(this).remove(); });
                        showAlert('success', res.message);
                    } else {
                        showAlert('danger', res.message);
                    }
                }
            ).fail(function (xhr) {
                showAlert('danger', 'Delete failed: ' + xhr.status);
            });
        }

        // ─── HELPERS ──────────────────────────────────────────────
        function showAlert(type, message) {
            $('#alertBox')
                .removeClass('d-none alert-success alert-danger')
                .addClass('alert-' + type)
                .text(message);
            setTimeout(function () { $('#alertBox').addClass('d-none'); }, 4000);
        }

        function getToken() {
            return $('input[name="__RequestVerificationToken"]').first().val();
        }
    </script>
}